var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _set2=_interopRequireDefault(require("@babel/runtime/helpers/set"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _get2=_interopRequireDefault(require("@babel/runtime/helpers/get"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _RCTView2=_interopRequireDefault(require("./../RCTView"));var _RCTImageSource=_interopRequireDefault(require("./RCTImageSource"));var _ColorArrayFromHexARGB=_interopRequireDefault(require("./../../utils/ColorArrayFromHexARGB"));var _prefixInlineStyles=_interopRequireDefault(require("./../../utils/prefixInlineStyles"));var _isIOS=_interopRequireDefault(require("./../../utils/isIOS"));var tintColorSVG=function tintColorSVG(color,id){return"\n    <svg>\n      <defs>\n        <filter id=\"tint-"+id+"\">\n          <feFlood flood-color=\""+color+"\"></feFlood>\n          <feComposite in2=\"SourceAlpha\" operator=\"atop\"></feComposite>\n        </filter>\n      </defs>\n    </svg>";};var onLoadParamsForSource=function onLoadParamsForSource(source){return{source:{width:source.size.width,height:source.size.height,url:source.request}};};var idCounter=0;var RCTImageView=function(_RCTView){(0,_inherits2.default)(RCTImageView,_RCTView);function RCTImageView(bridge){var _this;(0,_classCallCheck2.default)(this,RCTImageView);_this=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(RCTImageView).call(this,bridge));_this.onLoadStart=false;_this.onLoad=false;_this.onLoadEnd=false;_this._needsReload=false;(0,_extends2.default)(_this.style,{overflow:"hidden"});_this._imageSources=[];_this.svgFilter=document.createElement("div");_this.svgFilter.style.height="0";_this.childContainer.appendChild(_this.svgFilter);_this.filterId=idCounter;idCounter++;_this.imageElement=new Image();_this.imageElementAlt=new Image();_this.imageElement.setAttribute("draggable","false");_this.imageElementAlt.setAttribute("draggable","false");_this.resizeMode=undefined;_this.imageElement.addEventListener("load",function(){_this.forceRasterization();});return _this;}(0,_createClass2.default)(RCTImageView,[{key:"updateFilter",value:function updateFilter(){var filterStrings=[];if(this._tintColor){filterStrings.push("url(#tint-"+this.filterId+")");}if(this._blurRadius){filterStrings.push("blur("+this._blurRadius+"px)");}this.imageElement.style.webkitFilter=filterStrings.join(" ");this.imageElement.style.filter=filterStrings.join(" ");this.imageElementAlt.style.webkitFilter=filterStrings.join(" ");this.imageElementAlt.style.filter=filterStrings.join(" ");}},{key:"updateTile",value:function updateTile(){var style;if(this._tile){var _this$frameSize=this.frameSize,frameWidth=_this$frameSize.width,frameHeight=_this$frameSize.height,src=this._src,imageWidth=this._imageWidth,imageHeight=this._imageHeight;if(!frameWidth||!frameHeight||!imageWidth||!imageHeight||!src){return;}var scaleDownFactor=Math.min(1,frameWidth/imageWidth,frameHeight/imageHeight);style={backgroundImage:"url("+encodeURI(src)+")",backgroundSize:"\n          "+scaleDownFactor*imageWidth+"px\n          "+scaleDownFactor*imageHeight+"px\n        ",backgroundRepeat:"repeat",backgroundPosition:"0 0",objectPosition:-imageWidth-1+"px "+(-imageHeight-1)+"px"};}else{style={backgroundImage:"",backgroundSize:"",backgroundRepeat:"",backgroundPosition:"",objectPosition:""};}(0,_extends2.default)(this.imageElement.style,style);(0,_extends2.default)(this.imageElementAlt.style,style);}},{key:"forceRasterization",value:function forceRasterization(){var mountedImage=this.mountedImage;if(this._tintColor!=null&&mountedImage!=null){requestAnimationFrame(function(){mountedImage.style.willChange="transform";requestAnimationFrame(function(){mountedImage.style.willChange="auto";});});}}},{key:"hasMultipleSources",value:function hasMultipleSources(){return this._imageSources.length>1;}},{key:"imageSourceForSize",value:function imageSourceForSize(size){if(!this.hasMultipleSources()){return this._imageSources[0];}if(size.width===0&&size.height===0){return null;}var scale=this.imageScale;var targetImagePixels=size.width*size.height*scale*scale;var bestSource=null;var bestFit=Infinity;for(var _iterator=this._imageSources,_isArray=Array.isArray(_iterator),_i=0,_iterator=_isArray?_iterator:_iterator[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref;if(_isArray){if(_i>=_iterator.length)break;_ref=_iterator[_i++];}else{_i=_iterator.next();if(_i.done)break;_ref=_i.value;}var _source=_ref;var imgSize=_source.size;var imagePixels=imgSize.width*imgSize.height*_source.scale*_source.scale;var fit=Math.abs(1-imagePixels/targetImagePixels);if(fit<bestFit){bestFit=fit;bestSource=_source;}}return bestSource;}},{key:"reloadImage",value:function reloadImage(){var _this2=this;var source=this.imageSourceForSize(this.frameSize);if(source&&this.frameSize.width>0&&this.frameSize.height>0){if(this.onLoadStart){this.bridge.enqueueJSCall("RCTEventEmitter","receiveEvent",[this.reactTag,"topLoadStart",null]);}this.bridge.imageLoader.loadImageWithURLRequest(source.request).then(function(image){var pendingImage=_this2.mountedImage===_this2.imageElement?_this2.imageElementAlt:_this2.imageElement;pendingImage.src=image.src;_this2._src=pendingImage.src;if(!pendingImage.src.startsWith("data:")&&typeof pendingImage.decode==="function"){return pendingImage.decode().then(function(){return pendingImage;});}return pendingImage;}).then(function(image){_this2._imageWidth=image.width;_this2._imageHeight=image.height;_this2.updateTile();_this2.mountedImage&&_this2.mountedImage.remove();_this2.childContainer.appendChild(image);_this2.mountedImage=image;if(_this2.onLoad){var sourceLoaded=source.imageSourceWithSizeAndScale({width:image.width,height:image.height},source.scale);_this2.bridge.enqueueJSCall("RCTEventEmitter","receiveEvent",[_this2.reactTag,"topLoad",onLoadParamsForSource(sourceLoaded)]);}}).catch(function(err){_this2.bridge.enqueueJSCall("RCTEventEmitter","receiveEvent",[_this2.reactTag,"topError",{error:err}]);}).then(function(){if(_this2.onLoadEnd){_this2.bridge.enqueueJSCall("RCTEventEmitter","receiveEvent",[_this2.reactTag,"topLoadEnd",null]);}_this2.updateFilter();});}}},{key:"imageSources",set:function set(value){this._imageSources=value;this.reloadImage();}},{key:"resizeMode",set:function set(value){value=value||"stretch";var outputValue="";switch(value){case"contain":case"cover":outputValue=value;break;case"repeat":case"center":outputValue="scale-down";break;case"stretch":outputValue="fill";break;case"none":outputValue="none";break;}(0,_extends2.default)(this.imageElement.style,{objectFit:outputValue});(0,_extends2.default)(this.imageElementAlt.style,{objectFit:outputValue});this._tile=value==="repeat";this.updateTile();}},{key:"blurRadius",set:function set(value){this._blurRadius=value;this.updateFilter();}},{key:"tintColor",set:function set(value){this._tintColor=value;this.svgFilter.innerHTML=this._tintColor?tintColorSVG(this._tintColor,this.filterId):"";this.updateFilter();this.forceRasterization();}},{key:"imageScale",get:function get(){return this.bridge.deviceInfo.getDevicePixelRatio();}},{key:"frame",get:function get(){return(0,_get2.default)((0,_getPrototypeOf2.default)(RCTImageView.prototype),"frame",this);},set:function set(value){var prevWidth=this.width;var prevHeight=this.height;(0,_set2.default)((0,_getPrototypeOf2.default)(RCTImageView.prototype),"frame",value,this,true);var width=value.width,height=value.height;(0,_extends2.default)(this.imageElement.style,{width:width+"px",height:height+"px"});(0,_extends2.default)(this.imageElementAlt.style,{width:width+"px",height:height+"px"});if(prevWidth!==width||prevHeight!==height){this.reloadImage();}}},{key:"frameSize",get:function get(){var _this$frame=this.frame,width=_this$frame.width,height=_this$frame.height;return{width:width,height:height};}}]);return RCTImageView;}(_RCTView2.default);customElements.define("rct-image-view",RCTImageView);var _default=RCTImageView;exports.default=_default;
//# sourceMappingURL=RCTImageView.js.map