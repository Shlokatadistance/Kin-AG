var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard");var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.RCTScrollContentView=exports.default=void 0;var _construct2=_interopRequireDefault(require("@babel/runtime/helpers/construct"));var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _get2=_interopRequireDefault(require("@babel/runtime/helpers/get"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _set2=_interopRequireDefault(require("@babel/runtime/helpers/set"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _objectSpread2=_interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _detectIt=_interopRequireDefault(require("detect-it"));var _debounce=_interopRequireDefault(require("debounce"));var _invariant=_interopRequireDefault(require("invariant"));var _RCTView3=_interopRequireDefault(require("./RCTView"));var _UIView=_interopRequireDefault(require("./../base/UIView"));var _RCTScrollViewLocalData=_interopRequireDefault(require("./RCTScrollViewLocalData"));var _isIOS=_interopRequireDefault(require("./../utils/isIOS"));var _RCTEventDispatcher=_interopRequireWildcard(require("./../bridge/RCTEventDispatcher"));var isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);var SCROLL_LISTENER_OPTIONS=_detectIt.default.passiveEvents?{passive:true}:false;var RCTScrollEvent=function(){function RCTScrollEvent(eventName,reactTag,contentOffset,contentInset,contentSize,scrollFrame,zoomScale,coalescingKey,userData){(0,_classCallCheck2.default)(this,RCTScrollEvent);this.eventName=eventName;this.viewTag=reactTag;this.scrollViewContentOffset=contentOffset;this.scrollViewContentInset=contentInset;this.scrollViewContentSize=contentSize;this.scrollViewFrame=scrollFrame;this.scrollViewZoomScale=zoomScale;this.userData=userData;this.coalescingKey=coalescingKey;}(0,_createClass2.default)(RCTScrollEvent,[{key:"canCoalesce",value:function canCoalesce(){return true;}},{key:"coalesceWithEvent",value:function coalesceWithEvent(newEvent){var updatedChildFrames=[];if(this.userData&&this.userData.updatedChildFrames)updatedChildFrames=updatedChildFrames.concat(this.userData.updatedChildFrames);if(newEvent.userData&&newEvent.userData.updatedChildFrames)updatedChildFrames=updatedChildFrames.concat(newEvent.userData.updatedChildFrames);if(updatedChildFrames.length!==0){newEvent.userData={updatedChildFrames:updatedChildFrames};}return newEvent;}},{key:"moduleDotMethod",value:function moduleDotMethod(){return"RCTEventEmitter.receiveEvent";}},{key:"arguments",value:function _arguments(){var args=[this.viewTag,(0,_RCTEventDispatcher.normalizeInputEventName)(this.eventName),this.body];return args;}},{key:"body",get:function get(){var body={contentOffset:(0,_objectSpread2.default)({},this.scrollViewContentOffset),contentInset:(0,_objectSpread2.default)({},this.scrollViewContentInset),contentSize:(0,_objectSpread2.default)({},this.scrollViewContentSize),layoutMeasurement:{width:this.scrollViewFrame.width,height:this.scrollViewFrame.height},zoomScale:this.scrollViewZoomScale};var userData=this.userData;if(userData){body=(0,_objectSpread2.default)({},body,userData);}return body;}}]);return RCTScrollEvent;}();var RCTScrollContentView=function(_RCTView){(0,_inherits2.default)(RCTScrollContentView,_RCTView);function RCTScrollContentView(bridge){var _this;(0,_classCallCheck2.default)(this,RCTScrollContentView);_this=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(RCTScrollContentView).call(this,bridge));_this.updateHostStyle({position:"relative",display:"block",opacity:"1",contain:"layout style"});if(isSafari){_this.addWillChange("transform");}return _this;}(0,_createClass2.default)(RCTScrollContentView,[{key:"frame",set:function set(value){(0,_set2.default)((0,_getPrototypeOf2.default)(RCTScrollContentView.prototype),"frame",value,this,true);var superView=this.reactSuperview;var subView=this.reactSubviews[0];if(subView&&subView instanceof _RCTView3.default&&superView&&superView instanceof RCTScrollView){superView.boundsDidChange(subView);}},get:function get(){return(0,_get2.default)((0,_getPrototypeOf2.default)(RCTScrollContentView.prototype),"frame",this);}}]);return RCTScrollContentView;}(_RCTView3.default);exports.RCTScrollContentView=RCTScrollContentView;function setScrollPadding(node){var scrollTop=node.scrollTop,offsetHeight=node.offsetHeight,scrollHeight=node.scrollHeight;if(scrollTop<=0){node.scrollTop=1;}if(scrollTop+offsetHeight>=scrollHeight){node.scrollTop=scrollHeight-offsetHeight-1;}}customElements.define("rct-scroll-content-view",RCTScrollContentView);var RCTScrollView=function(_RCTView2){(0,_inherits2.default)(RCTScrollView,_RCTView2);function RCTScrollView(bridge){var _this2;(0,_classCallCheck2.default)(this,RCTScrollView);_this2=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(RCTScrollView).call(this,bridge));_this2.contentSize={width:0,height:0};_this2.onTouchStart=function(){setScrollPadding((0,_assertThisInitialized2.default)((0,_assertThisInitialized2.default)(_this2)));};_this2.handleScroll=function _callee(e,userData){var _this3;var scrollLeft,scrollTop,contentOffset,contentInset,contentSize,shadowView,contentFrame,args,_this4,_this5;return _regenerator.default.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_this2.coalescingKey++;scrollLeft=_this2.scrollLeft;scrollTop=_this2.scrollTop;contentOffset={x:scrollLeft,y:scrollTop};_this2.scrollDidChange(scrollLeft,scrollTop);contentInset={top:0,left:0,bottom:0,right:0};contentSize={width:_this2.scrollWidth,height:_this2.scrollHeight};shadowView=_this2.manager.shadowViewRegistry.get(_this2.reactTag);(0,_invariant.default)(shadowView,"No ShadowView for tag "+_this2.reactTag);contentFrame=shadowView.previousLayout;(0,_invariant.default)(contentFrame,"ShadowView with tag "+_this2.reactTag+" has not been layed out");args=[_this2.reactTag,contentOffset,contentInset,contentSize,contentFrame,1,_this2.coalescingKey,userData];(_this3=_this2).debouncedOnScrollEnd.apply(_this3,args);if(_this2.isScrolling){(_this4=_this2).handleScrollTick.apply(_this4,args);}else{(_this5=_this2).handleScrollStart.apply(_this5,args);}case 14:case"end":return _context.stop();}}},null,this);};_this2.debouncedOnScrollEnd=(0,_debounce.default)(_this2.handleScrollEnd,100);_this2.manager=bridge.uiManager;_this2.updateHostStyle("contain","strict");_this2.updateChildContainerStyle("contain","style size");if(!_this2.hasScrollParent()){_this2.updateHostStyle("overscrollBehavior","contain");}_this2.isScrolling=false;_this2.scrollEventThrottle=0;_this2.coalescingKey=0;_this2.cachedChildFrames=[];_this2._horizontal=false;_this2._overflow="scroll";_this2._scrollEnabled=true;if(isSafari){_this2.addWillChange("transform");}_this2.addEventListener("scroll",_this2.handleScroll,SCROLL_LISTENER_OPTIONS);if(_isIOS.default){_this2.addEventListener("touchstart",_this2.onTouchStart,_detectIt.default.passiveEvents?{passive:true}:false);}return _this2;}(0,_createClass2.default)(RCTScrollView,[{key:"hasScrollParent",value:function hasScrollParent(){var currentView=this;while(currentView.reactSuperview){if(currentView instanceof RCTScrollView){return true;}currentView=currentView.reactSuperView;}return false;}},{key:"updateScrollBehavior",value:function updateScrollBehavior(){var styleUpdate={};if(this._overflow==="scroll"&&this._scrollEnabled){styleUpdate.msOverflowStyle="-ms-autohiding-scrollbar";styleUpdate.webkitOverflowScrolling="touch";if(this._horizontal){styleUpdate.overflowX="auto";styleUpdate.overflowY="hidden";styleUpdate.touchAction="pan-x";this.setAttribute("touch-action","pan-x");}else{styleUpdate.overflowX="hidden";styleUpdate.overflowY="auto";styleUpdate.touchAction="pan-y";this.setAttribute("touch-action","pan-y");}}else{styleUpdate.touchAction=undefined;this.removeAttribute("touch-action");styleUpdate.msOverflowStyle="auto";styleUpdate.webkitOverflowScrolling="";styleUpdate.overflowX="hidden";styleUpdate.overflowY="hidden";}this.updateHostStyle(styleUpdate);}},{key:"calculateChildFramesData",value:function calculateChildFramesData(){var _this6=this;var updatedChildFrames=[];var contentView=this.reactSubviews[0];(0,_invariant.default)(contentView&&contentView instanceof RCTScrollContentView,"RCTScrollView (of ID "+this.reactTag+") has no contentView");contentView.reactSubviews.forEach(function(subview,idx){var newFrame=subview.frame;var frameChanged=false;if(_this6.cachedChildFrames.length<=idx){frameChanged=true;}else if(JSON.stringify(newFrame)!==JSON.stringify(_this6.cachedChildFrames[idx])){frameChanged=true;}if(frameChanged){updatedChildFrames.push({index:idx,x:newFrame.left,y:newFrame.top,width:newFrame.width,height:newFrame.height});}});return updatedChildFrames;}},{key:"connectedCallback",value:function connectedCallback(){this.correctScrollPosition();}},{key:"boundsDidChange",value:function boundsDidChange(contentView){this.coalescingKey++;var childFrames=this.calculateChildFramesData();var contentOffset={x:this.scrollLeft,y:this.scrollTop};var contentInset={top:0,left:0,bottom:0,right:0};var contentSize={width:this.scrollWidth,height:this.scrollHeight};var shadowView=this.manager.shadowViewRegistry.get(this.reactTag);(0,_invariant.default)(shadowView,"No ShadowView for tag "+this.reactTag);var contentFrame=shadowView.previousLayout;(0,_invariant.default)(contentFrame,"ShadowView with tag "+this.reactTag+" has not been layed out");this.contentSize={width:contentFrame.width,height:contentFrame.height};var args=[this.reactTag,contentOffset,contentInset,contentSize,contentFrame,1,this.coalescingKey];this.bridge.eventDispatcher.sendEvent((0,_construct2.default)(RCTScrollEvent,["onScroll"].concat(args,[{updatedChildFrames:childFrames}])));}},{key:"scrollDidChange",value:function scrollDidChange(x,y){var _this7=this;setTimeout(function(){var localData=new _RCTScrollViewLocalData.default(x,y);_this7.bridge.uiManager.setLocalDataForView(localData,_this7);},0);}},{key:"handleScrollStart",value:function handleScrollStart(){this.isScrolling=true;this._scrollLastTick=Date.now();for(var _len=arguments.length,eventArgs=new Array(_len),_key=0;_key<_len;_key++){eventArgs[_key]=arguments[_key];}var scrollEvent=(0,_construct2.default)(RCTScrollEvent,["onScrollBeginDrag"].concat(eventArgs));this.bridge.eventDispatcher.sendEvent(scrollEvent);}},{key:"handleScrollEnd",value:function handleScrollEnd(){this.isScrolling=false;for(var _len2=arguments.length,eventArgs=new Array(_len2),_key2=0;_key2<_len2;_key2++){eventArgs[_key2]=arguments[_key2];}var scrollEvent=(0,_construct2.default)(RCTScrollEvent,["onScrollEndDrag"].concat(eventArgs));this.bridge.eventDispatcher.sendEvent(scrollEvent);var momentumScrollEvent=(0,_construct2.default)(RCTScrollEvent,["onMomentumScrollEnd"].concat(eventArgs));this.bridge.eventDispatcher.sendEvent(momentumScrollEvent);this.correctScrollPosition();}},{key:"correctScrollPosition",value:function correctScrollPosition(){var scrollNudge=1;if(_isIOS.default){if(!this._horizontal){var endTopPosition=this.scrollTop+this.contentSize.height;if(this.scrollTop<=0&&this.scrollTop>=-0.1){this.scrollTop=scrollNudge;}else if(endTopPosition>=this.scrollHeight&&endTopPosition<=this.scrollHeight+0.1){this.scrollTop=this.scrollTop-scrollNudge;}}else{var endLeftPosition=this.scrollLeft+this.contentSize.width;if(this.scrollLeft<=0&&this.scrollLeft>=-0.1){this.scrollLeft=scrollNudge;}else if(endLeftPosition>=this.scrollWidth&&endLeftPosition<=this.scrollWidth+0.1){this.scrollLeft=this.scrollLeft-scrollNudge;}}}}},{key:"handleScrollTick",value:function handleScrollTick(){var shouldEmitScrollEvent=this.shouldEmitScrollEvent(this._scrollLastTick,this.scrollEventThrottle);if(shouldEmitScrollEvent){this._scrollLastTick=Date.now();for(var _len3=arguments.length,eventArgs=new Array(_len3),_key3=0;_key3<_len3;_key3++){eventArgs[_key3]=arguments[_key3];}var scrollEvent=(0,_construct2.default)(RCTScrollEvent,["onScroll"].concat(eventArgs));this.bridge.eventDispatcher.sendEvent(scrollEvent);}}},{key:"shouldEmitScrollEvent",value:function shouldEmitScrollEvent(lastTick,eventThrottle){var timeSinceLastTick=Date.now()-lastTick;return eventThrottle>0&&timeSinceLastTick>=eventThrottle;}},{key:"scrollEnabled",set:function set(value){this._scrollEnabled=!!value;this.updateScrollBehavior();}},{key:"horizontal",set:function set(value){this._horizontal=!!value;this.updateScrollBehavior();}},{key:"overflow",set:function set(value){if(value!=null){this._overflow=value;}else{this._overflow="hidden";}this.updateScrollBehavior();}},{key:"scrollBehavior",set:function set(value){this.updateHostStyle({scrollBehavior:value});}},{key:"touchable",get:function get(){return(0,_get2.default)((0,_getPrototypeOf2.default)(RCTScrollView.prototype),"touchable",this);},set:function set(value){this._touchable=value;this.updateDerivedPointerEvents();this.updateHostStyle("cursor","auto");}}]);return RCTScrollView;}(_RCTView3.default);customElements.define("rct-scroll-view",RCTScrollView);var _default=RCTScrollView;exports.default=_default;
//# sourceMappingURL=RCTScrollView.js.map