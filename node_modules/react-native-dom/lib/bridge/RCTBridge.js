var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard");var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.getPropertyNames=getPropertyNames;Object.defineProperty(exports,"RCTFunctionTypeNormal",{enumerable:true,get:function get(){return _RCTBridgeMethod.RCTFunctionTypeNormal;}});Object.defineProperty(exports,"RCTFunctionTypePromise",{enumerable:true,get:function get(){return _RCTBridgeMethod.RCTFunctionTypePromise;}});Object.defineProperty(exports,"RCTFunctionTypeSync",{enumerable:true,get:function get(){return _RCTBridgeMethod.RCTFunctionTypeSync;}});exports.default=void 0;var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _invariant=_interopRequireDefault(require("invariant"));var _RCTModuleConfig=require("./RCTModuleConfig");var _NotificationCenter=_interopRequireDefault(require("./../base/NotificationCenter"));var _RCTBridgeMethod=require("./RCTBridgeMethod");var _RCTModule=_interopRequireWildcard(require("./RCTModule"));var MODULE_IDS=0;var METHOD_IDS=1;var PARAMS=2;var DEVTOOLS_FLAG=/\bdevtools\b/;var HOTRELOAD_FLAG=/\bhotreload\b/;var WORKER_SRC="function sendMessage(topic, payload) {\n  postMessage({ topic, payload });\n}\n\nlet Status = undefined;\n\nfunction loadBundle(bundle) {\n  return new Promise(function(resolve, reject) {\n    if (__DEV__) {\n      let xmlHttp = new XMLHttpRequest();\n      xmlHttp.open(\"GET\", bundle, true);\n      xmlHttp.setRequestHeader(\"Accept\", \"multipart/mixed\");\n      xmlHttp.onload = function() {\n        importScripts(bundle);\n        resolve();\n      };\n      xmlHttp.onerror = function(evt) {\n        reject(evt);\n      };\n      xmlHttp.onabort = function(evt) {\n        reject(evt);\n      };\n      xmlHttp.onprogress = function(evt) {\n        const progressEvents = xmlHttp.response.match(/\\{[\\S]*\\}/g);\n        if (progressEvents) {\n          try {\n            const { done, total } = JSON.parse(\n              progressEvents[progressEvents.length - 1]\n            );\n            if (done && total) {\n              sendMessage(\"updateProgress\", { done, total });\n            }\n          } catch (err) {\n            /* silence parse errors */\n          }\n        }\n      };\n      xmlHttp.send();\n    } else {\n      importScripts(bundle);\n      resolve();\n    }\n  });\n}\n\nfunction handleError(e) {\n  console.warn(e);\n  let xmlhttp = new XMLHttpRequest();\n  xmlhttp.open(\"GET\", bundle, true);\n  xmlhttp.onreadystatechange = function() {\n    if (xmlhttp.readyState == 4) {\n      let result = JSON.parse(xmlhttp.responseText);\n      if (result) {\n        if (\n          result.type === \"UnableToResolveError\" ||\n          result.type === \"NotFoundError\"\n        ) {\n          console.warn(result.message);\n        } else {\n          if (result.snippet) {\n            // remove all color characters and split the lines for improved clarity\n            result.snippet = result.snippet\n              .replace(/\\u001b\\[.*?m/g, \"\")\n              .split(\"\\\\n\");\n          }\n          if (result.filename && result.filename.indexOf(\":\") <= 2) {\n            result.filename = \"file:///\" + result.filename;\n          }\n          if (result.errors) {\n            for (let i = 0; i < result.errors.length; i++) {\n              let error = result.errors[i];\n              if (error.filename && error.filename.indexOf(\":\") <= 2) {\n                error.filename = \"file:///\" + error.filename;\n              }\n            }\n          }\n          console.warn(JSON.stringify(result, undefined, 2));\n        }\n      }\n    }\n    xmlhttp.send(null);\n  };\n}\n\nonmessage = ({ data }) => {\n  const { topic, payload } = data;\n  // console.log(\"Recieved message from main thread:\", topic, payload);\n\n  switch (topic) {\n    case \"loadBridgeConfig\": {\n      const { config, bundle } = payload;\n      __fbBatchedBridgeConfig = config;\n      loadBundle(bundle)\n        .then(function() {\n          sendMessage(\"bundleFinishedLoading\");\n        })\n        .catch(handleError);\n      break;\n    }\n    case \"callFunctionReturnFlushedQueue\": {\n      try {\n        if (self.__fbBatchedBridge) {\n          const flushedQueue = __fbBatchedBridge.callFunctionReturnFlushedQueue(\n            ...payload\n          );\n          sendMessage(\"flushedQueue\", flushedQueue);\n        }\n      } catch (e) {\n        console.warn(e);\n        console.warn(\"topic\", topic);\n        console.warn(\"payload\", payload);\n      }\n      break;\n    }\n    case \"invokeCallbackAndReturnFlushedQueue\": {\n      try {\n        if (self.__fbBatchedBridge) {\n          const flushedQueue = __fbBatchedBridge.invokeCallbackAndReturnFlushedQueue(\n            ...payload\n          );\n          sendMessage(\"flushedQueue\", flushedQueue);\n        }\n      } catch (e) {\n        console.warn(e);\n        console.warn(\"topic\", topic);\n        console.warn(\"payload\", payload);\n      }\n      break;\n    }\n    case \"flush\": {\n      try {\n        if (self.__fbBatchedBridge) {\n          const flushedQueue = __fbBatchedBridge.flushedQueue.apply(null);\n          sendMessage(\"flushedQueue\", flushedQueue);\n        }\n      } catch (e) {\n        console.warn(e);\n        console.warn(\"topic\", topic);\n        console.warn(\"payload\", payload);\n      }\n      break;\n    }\n  }\n};\n";if(__DEV__){WORKER_SRC="__DEV__ = true;\n"+WORKER_SRC;if(DEVTOOLS_FLAG.test(location.search)){WORKER_SRC="__DEVTOOLS__ = true;\n"+WORKER_SRC;if(window.__REACT_DEVTOOLS_GLOBAL_HOOK__){console.log("We detected that you have the React Devtools extension installed. "+"Please note that at this time, React Native DOM is only compatible with the "+"standalone version of React Developer Tools.");}}}else{WORKER_SRC="__DEV__ = false;\n"+WORKER_SRC;}function getPropertyNames(obj){if(obj==null)return[];var currentPropertyNames=Object.getOwnPropertyNames(obj);return currentPropertyNames.concat(getPropertyNames(Object.getPrototypeOf(obj)));}var RCTBridge=function(){function RCTBridge(_moduleName,bundle,nativeModules,parent,urlScheme,basename){var _this=this;(0,_classCallCheck2.default)(this,RCTBridge);this.modulesByName={};this.moduleClasses=[];this.moduleConfigs=[];this.messages=[];this.queue=[];this.executing=false;this.initializeModules=function _callee(){return _regenerator.default.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return _regenerator.default.awrap(Promise.all(_this.nativeModules));case 2:_this.moduleClasses=_context.sent;_this.moduleClasses=_this.moduleClasses.map(function(maybeModule){return maybeModule.default!=null?maybeModule.default:maybeModule;});_this.moduleClasses.forEach(function(moduleClass){var module=new moduleClass(_this);var moduleName=(0,_RCTModule.bridgeModuleNameForClass)(moduleClass);_this.modulesByName[moduleName]=module;});case 5:case"end":return _context.stop();}}},null,this);};this.getInitialModuleConfig=function(){var remoteModuleConfig=[];for(var moduleName in _this.modulesByName){var bridgeModule=_this.modulesByName[moduleName];var description=_this.generateModuleConfig(moduleName,bridgeModule);remoteModuleConfig.push(description);}return{remoteModuleConfig:remoteModuleConfig};};this.loading=true;this.moduleName=_moduleName;this.bundleLocation=bundle;this.nativeModules=nativeModules;this.parent=parent;this.urlScheme=urlScheme;this.basename=basename;var bridgeCodeBlob=new Blob([WORKER_SRC]);var worker=new Worker(URL.createObjectURL(bridgeCodeBlob));this.setThread(worker);}(0,_createClass2.default)(RCTBridge,[{key:"moduleForClass",value:function moduleForClass(cls){return this.modulesByName[(0,_RCTModule.bridgeModuleNameForClass)(cls)];}},{key:"setThread",value:function setThread(thread){this.thread=thread;thread.onmessage=this.onMessage.bind(this);}},{key:"sendMessage",value:function sendMessage(topic,payload){if(this.thread){this.thread.postMessage({topic:topic,payload:payload});}}},{key:"callNativeModule",value:function callNativeModule(moduleId,methodId,params){var _this2=this;var moduleConfig=this.moduleConfigs[moduleId];(0,_invariant.default)(moduleConfig,"No such module with id: "+moduleId);var _moduleConfig=(0,_slicedToArray2.default)(moduleConfig,4),name=_moduleConfig[0],promiseMethods=_moduleConfig[3];var nativeModule=this.modulesByName[name];(0,_invariant.default)(nativeModule,"No such module with name "+name);var nativeMethod=nativeModule.functionMap[methodId];if(promiseMethods.includes(methodId)){var _params$splice=params.splice(-2,2),_params$splice2=(0,_slicedToArray2.default)(_params$splice,2),resolveId=_params$splice2[0],rejectId=_params$splice2[1];Promise.resolve(nativeMethod.apply(nativeModule,params)).then(function(res){res=JSON.parse(JSON.stringify(res));_this2.callbackFromId(resolveId)(res);}).catch(function(err){err=JSON.parse(JSON.stringify(err));_this2.callbackFromId(rejectId)(err);});}else{nativeModule.functionMap[methodId].apply(nativeModule,params);}}},{key:"onMessage",value:function onMessage(message){var _message$data=message.data,topic=_message$data.topic,payload=_message$data.payload;switch(topic){case"bundleFinishedLoading":{this.loading=false;_NotificationCenter.default.emitEvent("RCTJavaScriptDidLoadNotification");if(this.bundleFinishedLoading){this.bundleFinishedLoading();}break;}case"flushedQueue":{if(payload!=null&&Array.isArray(payload)){var _payload=(0,_slicedToArray2.default)(payload,3),moduleIds=_payload[0],methodIds=_payload[1],params=_payload[2];for(var i=0;i<moduleIds.length;i++){this.messages.push({moduleId:moduleIds[i],methodId:methodIds[i],args:params[i]});}}break;}case"updateProgress":{this.devLoadingView.updateProgress(payload);break;}default:{console.warn("Unknown topic: "+topic);}}if(this.shouldContinue()){this.uiManager.requestTick();}}},{key:"generateModuleConfig",value:function generateModuleConfig(name,bridgeModule){var moduleDescription=bridgeModule._describe();this.moduleConfigs.push(moduleDescription);return moduleDescription;}},{key:"loadBridgeConfig",value:function loadBridgeConfig(){var config=this.getInitialModuleConfig();this.sendMessage("loadBridgeConfig",{config:config,bundle:this.bundleLocation});}},{key:"modulesConformingToProtocol",value:function modulesConformingToProtocol(protocol){return Object.values(this.modulesByName).filter(function(module){return module instanceof _RCTModule.default&&module instanceof protocol;});}},{key:"enqueueJSCall",value:function enqueueJSCall(moduleName,methodName,args){this.sendMessage("callFunctionReturnFlushedQueue",[moduleName,methodName,args]);}},{key:"enqueueJSCallWithDotMethod",value:function enqueueJSCallWithDotMethod(moduleDotMethod,args){var _moduleDotMethod$spli=moduleDotMethod.split("."),_moduleDotMethod$spli2=(0,_slicedToArray2.default)(_moduleDotMethod$spli,2),module=_moduleDotMethod$spli2[0],method=_moduleDotMethod$spli2[1];this.enqueueJSCall(module,method,args);}},{key:"enqueueJSCallback",value:function enqueueJSCallback(id,args){this.sendMessage("invokeCallbackAndReturnFlushedQueue",[id,args]);}},{key:"callbackFromId",value:function callbackFromId(id){var _this3=this;return function(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this3.enqueueJSCallback(id,args);};}},{key:"getModuleByName",value:function getModuleByName(name){var module=this.modulesByName[name];(0,_invariant.default)(module,"No such module found with name '"+name+"'");return module;}},{key:"frame",value:function frame(){var _this4=this;var messages;return _regenerator.default.async(function frame$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:this.sendMessage("flush");messages=(0,_toConsumableArray2.default)(this.messages);this.messages=[];messages.forEach(function(_ref){var moduleId=_ref.moduleId,methodId=_ref.methodId,args=_ref.args;_this4.callNativeModule(moduleId,methodId,args);});case 4:case"end":return _context2.stop();}}},null,this);}},{key:"shouldContinue",value:function shouldContinue(){return this.messages.length!==0;}},{key:"uiManager",get:function get(){if(!this._uiManager){var uiManager=this.modulesByName["UIManager"];this._uiManager=uiManager;}return this._uiManager;}},{key:"devLoadingView",get:function get(){if(!this._devLoadingView){var devLoadingView=this.modulesByName["DevLoadingView"];this._devLoadingView=devLoadingView;}return this._devLoadingView;}},{key:"eventDispatcher",get:function get(){if(!this._eventDispatcher){var eventDispatcher=this.modulesByName["EventDispatcher"];this._eventDispatcher=eventDispatcher;}return this._eventDispatcher;}},{key:"imageLoader",get:function get(){if(!this._imageLoader){var imageLoader=this.modulesByName["ImageLoader"];this._imageLoader=imageLoader;}return this._imageLoader;}},{key:"deviceInfo",get:function get(){if(!this._deviceInfo){var deviceInfo=this.modulesByName["DeviceInfo"];this._deviceInfo=deviceInfo;}return this._deviceInfo;}},{key:"devSettings",get:function get(){if(!this._devSettings){var devSettings=this.modulesByName["DevSettings"];this._devSettings=devSettings;}return this._devSettings;}},{key:"redBox",get:function get(){if(!this._redBox){var redBox=this.modulesByName["RedBox"];this._redBox=redBox;}return this._redBox;}},{key:"networking",get:function get(){if(!this._networking){var networking=this.modulesByName["Networking"];this._networking=networking;}return this._networking;}},{key:"blobManager",get:function get(){if(!this._blobManager){var blobModule=this.modulesByName["BlobModule"];this._blobManager=blobModule;}return this._blobManager;}}]);return RCTBridge;}();exports.default=RCTBridge;
//# sourceMappingURL=RCTBridge.js.map