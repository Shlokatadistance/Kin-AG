var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _RCTModule2=_interopRequireDefault(require("./../bridge/RCTModule"));var IDLE_CALLBACK_THRESHOLD=1;function now(){return window.performance?performance.now():Date.now();}var RCTTiming=function(_RCTModule){(0,_inherits2.default)(RCTTiming,_RCTModule);function RCTTiming(bridge){var _this;(0,_classCallCheck2.default)(this,RCTTiming);_this=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(RCTTiming).call(this,bridge));_this.timers={};_this.sendIdleEvents=false;_this.targetFrameDuration=1000.0/60.0;return _this;}(0,_createClass2.default)(RCTTiming,[{key:"$createTimer",value:function $createTimer(callbackId,duration,jsSchedulingTime,repeats){var currentTimeMillis=now();var currentDateNowTimeMillis=jsSchedulingTime+1000/60;var adjustedDuration=Math.max(0.0,jsSchedulingTime-currentDateNowTimeMillis+duration);var initialTargetTime=currentTimeMillis+adjustedDuration;var timer={callbackId:callbackId,duration:duration,jsSchedulingTime:initialTargetTime,repeats:repeats};if(adjustedDuration===0){if(timer.repeats){timer.jsSchedulingTime+=timer.duration;this.timers[String(callbackId)]=timer;}this.bridge.enqueueJSCall("JSTimers","callTimers",[[callbackId]]);}else{this.timers[String(callbackId)]=timer;}}},{key:"$deleteTimer",value:function $deleteTimer(callbackId){delete this.timers[String(callbackId)];}},{key:"$setSendIdleEvents",value:function $setSendIdleEvents(sendIdle){this.sendIdleEvents=sendIdle;}},{key:"frame",value:function frame(){var toRemove,timers,time,timer,t,_i,_timer;return _regenerator.default.async(function frame$(_context){while(1){switch(_context.prev=_context.next){case 0:toRemove=[];timers=[];time=now();for(timer in this.timers){t=this.timers[timer];if(t.jsSchedulingTime<=time){timers.push(this.timers[timer].callbackId);if(t.repeats){t.jsSchedulingTime+=t.duration;}else{toRemove.push(timer);}}}if(timers.length){this.bridge.enqueueJSCall("JSTimers","callTimers",[timers]);}for(_i=0;_i<toRemove.length;_i++){_timer=toRemove[_i];delete this.timers[_timer];}case 6:case"end":return _context.stop();}}},null,this);}},{key:"idle",value:function idle(frameStart){var frameNow,frameElapsed;return _regenerator.default.async(function idle$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(this.sendIdleEvents){_context2.next=2;break;}return _context2.abrupt("return");case 2:frameNow=now();frameElapsed=frameNow-frameStart;if(this.targetFrameDuration-frameElapsed>=IDLE_CALLBACK_THRESHOLD){this.bridge.enqueueJSCall("JSTimers","callIdleCallbacks",[Date.now()-frameElapsed]);}case 5:case"end":return _context2.stop();}}},null,this);}},{key:"shouldContinue",value:function shouldContinue(){return Object.keys(this.timers).length!==0;}}]);return RCTTiming;}(_RCTModule2.default);RCTTiming.moduleName="RCTTiming";var _default=RCTTiming;exports.default=_default;
//# sourceMappingURL=RCTTiming.js.map