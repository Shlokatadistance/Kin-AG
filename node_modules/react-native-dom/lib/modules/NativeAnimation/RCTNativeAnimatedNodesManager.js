var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _invariant=_interopRequireDefault(require("invariant"));var _RCTAnimatedNode=_interopRequireDefault(require("./Nodes/RCTAnimatedNode"));var _RCTValueAnimatedNode=_interopRequireDefault(require("./Nodes/RCTValueAnimatedNode"));var _RCTPropsAnimatedNode=_interopRequireDefault(require("./Nodes/RCTPropsAnimatedNode"));var _RCTStyleAnimatedNode=_interopRequireDefault(require("./Nodes/RCTStyleAnimatedNode"));var _RCTInterpolationAnimatedNode=_interopRequireDefault(require("./Nodes/RCTInterpolationAnimatedNode"));var _RCTTransformAnimatedNode=_interopRequireDefault(require("./Nodes/RCTTransformAnimatedNode"));var _RCTMultiplicationAnimatedNode=_interopRequireDefault(require("./Nodes/RCTMultiplicationAnimatedNode"));var _RCTAdditionAnimatedNode=_interopRequireDefault(require("./Nodes/RCTAdditionAnimatedNode"));var _RCTSubtractionAnimatedNode=_interopRequireDefault(require("./Nodes/RCTSubtractionAnimatedNode"));var _RCTModuloAnimatedNode=_interopRequireDefault(require("./Nodes/RCTModuloAnimatedNode"));var _RCTDivisionAnimatedNode=_interopRequireDefault(require("./Nodes/RCTDivisionAnimatedNode"));var _RCTTrackingAnimatedNode=_interopRequireDefault(require("./Nodes/RCTTrackingAnimatedNode"));var _RCTEventAnimation=_interopRequireDefault(require("./Drivers/RCTEventAnimation"));var _RCTFrameAnimation=_interopRequireDefault(require("./Drivers/RCTFrameAnimation"));var _RCTDecayAnimation=_interopRequireDefault(require("./Drivers/RCTDecayAnimation"));var _RCTSpringAnimation=_interopRequireDefault(require("./Drivers/RCTSpringAnimation"));var NODE_TYPE_MAP={style:_RCTStyleAnimatedNode.default,value:_RCTValueAnimatedNode.default,props:_RCTPropsAnimatedNode.default,interpolation:_RCTInterpolationAnimatedNode.default,transform:_RCTTransformAnimatedNode.default,multiplication:_RCTMultiplicationAnimatedNode.default,addition:_RCTAdditionAnimatedNode.default,subtraction:_RCTSubtractionAnimatedNode.default,modulus:_RCTModuloAnimatedNode.default,division:_RCTDivisionAnimatedNode.default,tracking:_RCTTrackingAnimatedNode.default};var DRIVER_TYPE_MAP={frames:_RCTFrameAnimation.default,decay:_RCTDecayAnimation.default,spring:_RCTSpringAnimation.default};var RCTNativeAnimatedNodesManager=function(){function RCTNativeAnimatedNodesManager(uiManager){(0,_classCallCheck2.default)(this,RCTNativeAnimatedNodesManager);this.uiManager=uiManager;this.animationNodes={};this.eventDrivers={};this.activeAnimations=new Set();this.ticking=false;}(0,_createClass2.default)(RCTNativeAnimatedNodesManager,[{key:"createAnimatedNode",value:function createAnimatedNode(tag,config){var nodeType=config.type;var NodeClass=NODE_TYPE_MAP[nodeType];if(!NodeClass){console.error("Animated node type "+nodeType+" not supported natively");return;}var node=new NodeClass(tag,config);node.manager=this;this.animationNodes[tag]=node;node.setNeedsUpdate();}},{key:"connectAnimatedNodes",value:function connectAnimatedNodes(parentTag,childTag){var parentNode=this.animationNodes[parentTag];var childNode=this.animationNodes[childTag];(0,_invariant.default)(parentNode,"no such parent node with id "+parentTag);(0,_invariant.default)(childNode,"no such child node with id "+childTag);parentNode.addChild(childNode);childNode.setNeedsUpdate();}},{key:"disconnectAnimatedNodes",value:function disconnectAnimatedNodes(parentTag,childTag){var parentNode=this.animationNodes[parentTag];var childNode=this.animationNodes[childTag];(0,_invariant.default)(parentNode,"no such parent node with id "+parentTag);(0,_invariant.default)(childNode,"no such child node with id "+childTag);parentNode.removeChild(childNode);childNode.setNeedsUpdate();}},{key:"connectAnimatedNodeToView",value:function connectAnimatedNodeToView(nodeTag,viewTag,viewName){var node=this.animationNodes[nodeTag];if(node instanceof _RCTPropsAnimatedNode.default){node.connectToView(viewTag,viewName,this.uiManager);}node.setNeedsUpdate();}},{key:"disconnectAnimatedNodeFromView",value:function disconnectAnimatedNodeFromView(nodeTag,viewTag){var node=this.animationNodes[nodeTag];if(node instanceof _RCTPropsAnimatedNode.default){node.disconnectFromView(viewTag);}}},{key:"dropAnimatedNode",value:function dropAnimatedNode(tag){var node=this.animationNodes[tag];if(node){node.detachNode();delete this.animationNodes[tag];}}},{key:"setAnimatedNodeValue",value:function setAnimatedNodeValue(nodeTag,value){var node=this.animationNodes[nodeTag];if(!(node instanceof _RCTValueAnimatedNode.default)){console.error("Not a value node.");return;}this.stopAnimationsForNode(node);node.value=value;node.setNeedsUpdate();}},{key:"setAnimatedNodeOffset",value:function setAnimatedNodeOffset(nodeTag,offset){var node=this.animationNodes[nodeTag];if(!(node instanceof _RCTValueAnimatedNode.default)){console.error("Not a value node.");return;}node.offset=offset;node.setNeedsUpdate();}},{key:"flattenAnimatedNodeOffset",value:function flattenAnimatedNodeOffset(nodeTag){var node=this.animationNodes[nodeTag];if(!(node instanceof _RCTValueAnimatedNode.default)){console.error("Not a value node.");return;}node.flattenOffset();}},{key:"extractAnimatedNodeOffset",value:function extractAnimatedNodeOffset(nodeTag){var node=this.animationNodes[nodeTag];if(!(node instanceof _RCTValueAnimatedNode.default)){console.error("Not a value node.");return;}node.extractOffset();}},{key:"startAnimatingNode",value:function startAnimatingNode(animationId,nodeTag,config,endCallback){var valueNode=this.animationNodes[nodeTag];(0,_invariant.default)(valueNode instanceof _RCTValueAnimatedNode.default,"Animation Node of id "+nodeTag+" is not a ValueAnimatedNode");var AnimationDriverClass=DRIVER_TYPE_MAP[config.type];if(AnimationDriverClass==null){console.error("Unsupported animation type: "+config.type);return;}var animationDriver=new AnimationDriverClass(animationId,config,valueNode,endCallback);this.activeAnimations.add(animationDriver);animationDriver.startAnimation();this.startAnimationLoopIfNeeded();}},{key:"stopAnimation",value:function stopAnimation(animationId){for(var _iterator=this.activeAnimations,_isArray=Array.isArray(_iterator),_i=0,_iterator=_isArray?_iterator:_iterator[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref;if(_isArray){if(_i>=_iterator.length)break;_ref=_iterator[_i++];}else{_i=_iterator.next();if(_i.done)break;_ref=_i.value;}var _driver=_ref;if(_driver.animationId===animationId){_driver.stopAnimation();this.activeAnimations.delete(_driver);break;}}}},{key:"stopAnimationsForNode",value:function stopAnimationsForNode(node){var _this=this;var discarded=[];this.activeAnimations.forEach(function(driver){if(driver.valueNode===node){discarded.push(driver);}});discarded.forEach(function(driver){driver.stopAnimation();_this.activeAnimations.delete(driver);});}},{key:"addAnimatedEventToView",value:function addAnimatedEventToView(viewTag,eventName,eventMapping){var nodeTag=eventMapping.animatedValueTag;var node=this.animationNodes[nodeTag];if(!node){console.error("Animated node with tag "+nodeTag+" does not exist");return;}if(!(node instanceof _RCTValueAnimatedNode.default)){console.error("Animated node connected to event should be of type RCTValueAnimatedNode");return;}var eventPath=eventMapping.nativeEventPath;var driver=new _RCTEventAnimation.default(eventPath,node);var key=""+viewTag+eventName;if(this.eventDrivers[key]!=null){this.eventDrivers[key].push(driver);}else{this.eventDrivers[key]=[driver];}}},{key:"removeAnimatedEventFromView",value:function removeAnimatedEventFromView(viewTag,eventName,animatedNodeTag){var key=""+viewTag+eventName;if(this.eventDrivers[key]!=null){if(this.eventDrivers[key].length===1){delete this.eventDrivers[key];}else{var driversForKey=this.eventDrivers[key];for(var i=0;i<driversForKey.length;i++){if(driversForKey[i].valueNode.nodeTag===animatedNodeTag){this.eventDrivers[key].splice(i,1);break;}}}}}},{key:"handleAnimatedEvent",value:function handleAnimatedEvent(event){if(Object.keys(this.eventDrivers).length===0){return;}var key=""+event.viewTag+event.eventName;var driversForKey=this.eventDrivers[key];if(driversForKey){for(var _iterator2=driversForKey,_isArray2=Array.isArray(_iterator2),_i2=0,_iterator2=_isArray2?_iterator2:_iterator2[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref2;if(_isArray2){if(_i2>=_iterator2.length)break;_ref2=_iterator2[_i2++];}else{_i2=_iterator2.next();if(_i2.done)break;_ref2=_i2.value;}var _driver2=_ref2;this.stopAnimationsForNode(_driver2.valueNode);_driver2.updateWithEvent(event);}this.updateAnimations();}}},{key:"startListeningToAnimatedNodeValue",value:function startListeningToAnimatedNodeValue(tag,valueObserver){var node=this.animationNodes[tag];if(node instanceof _RCTValueAnimatedNode.default){node.valueObserver=valueObserver;}}},{key:"stopListeningToAnimatedNodeValue",value:function stopListeningToAnimatedNodeValue(tag){var node=this.animationNodes[tag];if(node instanceof _RCTValueAnimatedNode.default){node.valueObserver=null;}}},{key:"startAnimationLoopIfNeeded",value:function startAnimationLoopIfNeeded(){if(!this.ticking&&this.activeAnimations.size>0){window.requestAnimationFrame(this.stepAnimations.bind(this));this.ticking=true;}}},{key:"stepAnimations",value:function stepAnimations(timestamp){for(var _iterator3=this.activeAnimations,_isArray3=Array.isArray(_iterator3),_i3=0,_iterator3=_isArray3?_iterator3:_iterator3[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref3;if(_isArray3){if(_i3>=_iterator3.length)break;_ref3=_iterator3[_i3++];}else{_i3=_iterator3.next();if(_i3.done)break;_ref3=_i3.value;}var _animationDriver2=_ref3;_animationDriver2.stepAnimationWithTime(timestamp);}this.updateAnimations();for(var _iterator4=this.activeAnimations,_isArray4=Array.isArray(_iterator4),_i4=0,_iterator4=_isArray4?_iterator4:_iterator4[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref4;if(_isArray4){if(_i4>=_iterator4.length)break;_ref4=_iterator4[_i4++];}else{_i4=_iterator4.next();if(_i4.done)break;_ref4=_i4.value;}var _animationDriver3=_ref4;if(_animationDriver3.animationHasFinished){_animationDriver3.stopAnimation();this.activeAnimations.delete(_animationDriver3);}}this.stopAnimationLoopIfNeeded();}},{key:"stopAnimationLoopIfNeeded",value:function stopAnimationLoopIfNeeded(){this.ticking=false;if(this.activeAnimations.size!==0){this.startAnimationLoopIfNeeded();}}},{key:"updateAnimations",value:function updateAnimations(){Object.values(this.animationNodes).forEach(function(node){if(node.needsUpdate){node.updateNodeIfNecessary();}});}}]);return RCTNativeAnimatedNodesManager;}();var _default=RCTNativeAnimatedNodesManager;exports.default=_default;
//# sourceMappingURL=RCTNativeAnimatedNodesManager.js.map