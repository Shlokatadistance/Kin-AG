var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _objectSpread2=_interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _detectIt=_interopRequireDefault(require("detect-it"));var _invariant=_interopRequireDefault(require("invariant"));var _UIView=_interopRequireDefault(require("./../base/UIView"));var _UIChildContainerView=_interopRequireDefault(require("./../base/UIChildContainerView"));var _RCTEventDispatcher=_interopRequireDefault(require("./../bridge/RCTEventDispatcher"));var _RCTTouchEvent=_interopRequireDefault(require("./RCTTouchEvent"));var _isIOS=_interopRequireDefault(require("./../utils/isIOS"));var _Guid=_interopRequireDefault(require("./../utils/Guid"));var mouseTouchCounter=1;var TOUCH_LISTENER_OPTIONS=_detectIt.default.passiveEvents?{passive:true,capture:false}:false;function getFirstParentUIView(target){while(target.parentElement){if(target instanceof _UIView.default||target instanceof _UIChildContainerView.default){return target;}target=target.parentElement;}return target;}var RCTTouchHandler=function(){function RCTTouchHandler(bridge){var _this=this;(0,_classCallCheck2.default)(this,RCTTouchHandler);this.stopPropagation=function(e){return e.stopPropagation();};this.preventDefault=function(e){return e.preventDefault();};this.pointerBegan=function(event){var touches=RCTTouchHandler.RCTNormalizeInteractionEvent(event);if(!touches)return;_this.touchesBegan(touches);var view=_this.view;if(view){view.addEventListener("pointerup",_this.pointerEnded,TOUCH_LISTENER_OPTIONS);view.addEventListener("pointermove",_this.pointerMoved,TOUCH_LISTENER_OPTIONS);view.addEventListener("pointercancel",_this.pointerCancelled,TOUCH_LISTENER_OPTIONS);}};this.pointerMoved=function(event){var touches=RCTTouchHandler.RCTNormalizeInteractionEvent(event);if(!touches)return;_this.touchesMoved(touches);};this.pointerEnded=function(event){var touches=RCTTouchHandler.RCTNormalizeInteractionEvent(event);if(!touches)return;_this.touchesEnded(touches);var view=_this.view;if(view){_this.removePointerEvents(view);}};this.pointerCancelled=function(event){var touches=RCTTouchHandler.RCTNormalizeInteractionEvent(event);if(!touches)return;_this.touchesCanceled(touches);var view=_this.view;if(view){_this.removePointerEvents(view);}};this.eventDispatcher=bridge.moduleForClass(_RCTEventDispatcher.default);this.nativeTouches=[];this.nativeTouchesByIdentifier={};this.reactTouches=[];this.touchViews=[];}(0,_createClass2.default)(RCTTouchHandler,[{key:"attachToView",value:function attachToView(view){this.view=view;view.addGestureRecognizer(this,_detectIt.default.deviceType,TOUCH_LISTENER_OPTIONS);if(_isIOS.default){view.addEventListener("touchmove",this.stopPropagation,TOUCH_LISTENER_OPTIONS);view.parentElement&&view.parentElement.addEventListener("touchmove",this.preventDefault,TOUCH_LISTENER_OPTIONS);}}},{key:"detachFromView",value:function detachFromView(view){this.view=undefined;view.removeGestureRecognizer(this,TOUCH_LISTENER_OPTIONS);if(_isIOS.default){view.removeEventListener("touchmove",this.stopPropagation,TOUCH_LISTENER_OPTIONS);view.parentElement&&view.parentElement.removeEventListener("touchmove",this.preventDefault,TOUCH_LISTENER_OPTIONS);}}},{key:"recordNewTouches",value:function recordNewTouches(touches){var _this2=this;touches.forEach(function(touch){(0,_invariant.default)(!_this2.nativeTouchesByIdentifier.hasOwnProperty(touch.identifier),"Touch is already recorded. This is a critical bug");var targetView=touch.view;while(targetView){if(targetView===_this2.view)break;if(targetView.reactTag&&targetView.touchable)break;targetView=targetView.parentElement;}var reactTag=targetView.reactTag;var touchID=touch.identifier;var reactTouch={target:reactTag,identifier:touchID};_this2.touchViews.push(targetView);_this2.nativeTouches.push(touch);_this2.nativeTouchesByIdentifier[touchID]=touch;_this2.reactTouches.push(reactTouch);});}},{key:"recordRemovedTouches",value:function recordRemovedTouches(touches){for(var _iterator=touches,_isArray=Array.isArray(_iterator),_i=0,_iterator=_isArray?_iterator:_iterator[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref;if(_isArray){if(_i>=_iterator.length)break;_ref=_iterator[_i++];}else{_i=_iterator.next();if(_i.done)break;_ref=_i.value;}var _touch=_ref;var nativeTouch=this.nativeTouchesByIdentifier[_touch.identifier];if(!nativeTouch){continue;}var index=this.nativeTouches.indexOf(nativeTouch);this.touchViews.splice(index,1);this.nativeTouches.splice(index,1);delete this.nativeTouchesByIdentifier[_touch.identifier];this.reactTouches.splice(index,1);}}},{key:"updateReactTouch",value:function updateReactTouch(touchIndex,newTouch){var reactTouch=this.reactTouches[touchIndex];var updatedReactTouch=(0,_objectSpread2.default)({},reactTouch,{pageX:newTouch.pageX,pageY:newTouch.pageY,locationX:newTouch.locationX,locationY:newTouch.locationY,timestamp:newTouch.timestamp});this.reactTouches[touchIndex]=updatedReactTouch;}},{key:"updateAndDispatchTouches",value:function updateAndDispatchTouches(touches,eventName){var changedIndexes=[];for(var _iterator2=touches,_isArray2=Array.isArray(_iterator2),_i2=0,_iterator2=_isArray2?_iterator2:_iterator2[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref2;if(_isArray2){if(_i2>=_iterator2.length)break;_ref2=_iterator2[_i2++];}else{_i2=_iterator2.next();if(_i2.done)break;_ref2=_i2.value;}var _touch2=_ref2;var nativeTouch=this.nativeTouchesByIdentifier[_touch2.identifier];if(!nativeTouch){console.log("updateAndDispatch failed");continue;}var index=this.nativeTouches.indexOf(nativeTouch);if(index===-1)continue;this.updateReactTouch(index,_touch2);changedIndexes.push(index);}if(changedIndexes.length===0){console.log("no changed Indexes");return;}var reactTouches=this.reactTouches.map(function(reactTouch){return(0,_objectSpread2.default)({},reactTouch);});var canBeCoalesced=eventName==="touchMove";if(!canBeCoalesced){this.coalescingKey++;}(0,_invariant.default)(this.view,"attempting to send event to unknown view");var event=new _RCTTouchEvent.default(eventName,this.view.reactTag,reactTouches,changedIndexes,this.coalescingKey);if(!canBeCoalesced){this.coalescingKey++;}this.eventDispatcher.sendEvent(event);}},{key:"removePointerEvents",value:function removePointerEvents(view){view.removeEventListener("pointerup",this.pointerEnded,TOUCH_LISTENER_OPTIONS);view.removeEventListener("pointermove",this.pointerMoved,TOUCH_LISTENER_OPTIONS);view.removeEventListener("pointercancel",this.pointerCancelled,TOUCH_LISTENER_OPTIONS);}},{key:"touchesBegan",value:function touchesBegan(touches){this.recordNewTouches(touches);this.updateAndDispatchTouches(touches,"touchStart");}},{key:"touchesMoved",value:function touchesMoved(touches){this.updateAndDispatchTouches(touches,"touchMove");}},{key:"touchesEnded",value:function touchesEnded(touches){this.updateAndDispatchTouches(touches,"touchEnd");this.recordRemovedTouches(touches);}},{key:"touchesCanceled",value:function touchesCanceled(touches){this.updateAndDispatchTouches(touches,"touchCancel");this.recordRemovedTouches(touches);}}],[{key:"RCTNormalizeInteractionEvent",value:function RCTNormalizeInteractionEvent(rawEvent){rawEvent.stopPropagation();var target=getFirstParentUIView(rawEvent.target);if("which"in rawEvent&&rawEvent.which===3){return null;}else if("button"in rawEvent&&rawEvent.button===2){return null;}return[{view:target,identifier:0,pageX:rawEvent.pageX,pageY:rawEvent.pageY,locationX:rawEvent.clientX,locationY:rawEvent.clientY,timestamp:performance.now()}];}}]);return RCTTouchHandler;}();var _default=RCTTouchHandler;exports.default=_default;
//# sourceMappingURL=RCTTouchHandler.js.map