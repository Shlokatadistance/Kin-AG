var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _RCTNativeEventEmitter=_interopRequireDefault(require("./RCTNativeEventEmitter"));function parseHttpHeaders(httpHeaders){if(httpHeaders==null)return{};return httpHeaders.split("\n").map(function(x){return x.split(/: */,2);}).filter(function(x){return x[0];}).reduce(function(ac,x){ac[x[0]]=x[1];return ac;},{});}var requestIdCounter=0;var RCTNetworkingNative=function(_RCTEventEmitter){(0,_inherits2.default)(RCTNetworkingNative,_RCTEventEmitter);function RCTNetworkingNative(bridge){var _this;(0,_classCallCheck2.default)(this,RCTNetworkingNative);_this=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(RCTNetworkingNative).call(this,bridge));_this.requestStore={};_this.handleLoadEnd=function(request){return function(){var responseURL=request.responseURL;var headers=parseHttpHeaders(request.getAllResponseHeaders());var status=request.status;var responseJSON=[request.requestId,status,headers,responseURL];_this.sendEventWithName("didReceiveNetworkResponse",responseJSON);};};_this.handleLoad=function(request,responseType){return function(){_this.sendData(request,responseType);var completeJSON=[request.requestId,null,false];_this.sendEventWithName("didCompleteNetworkResponse",completeJSON);delete _this.requestStore[request.requestId];};};_this.handleError=function(request){return function(){};};_this.handleAbort=function(request){return function(){};};_this.requestHandlers=[];_this.responseHandlers=[];return _this;}(0,_createClass2.default)(RCTNetworkingNative,[{key:"supportedMethods",value:function supportedMethods(){return["didCompleteNetworkResponse","didReceiveNetworkResponse","didSendNetworkData","didReceiveNetworkIncrementalData","didReceiveNetworkDataProgress","didReceiveNetworkData"];}},{key:"sendData",value:function sendData(request,responseType){for(var _iterator=this.responseHandlers,_isArray=Array.isArray(_iterator),_i=0,_iterator=_isArray?_iterator:_iterator[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref;if(_isArray){if(_i>=_iterator.length)break;_ref=_iterator[_i++];}else{_i=_iterator.next();if(_i.done)break;_ref=_i.value;}var _handler=_ref;if(_handler.canHandleNetworkingResponse(responseType)){var _responseData=_handler.handleNetworkingResponse(request,request.response);return this.sendEventWithName("didReceiveNetworkData",[request.requestId,_responseData]);}}var responseData=undefined;if(responseType==="text"&&typeof request.response==="string"){responseData=request.response;}else if(responseType==="text"&&typeof request.response==="object"){responseData=JSON.stringify(request.response);}else{console.warn("Invalid responseType "+responseType);return;}this.sendEventWithName("didReceiveNetworkData",[request.requestId,responseData]);}},{key:"$sendRequest",value:function $sendRequest(query,callbackId){var data=query.data,method=query.method,url=query.url,withCredentials=query.withCredentials,timeout=query.timeout,headers=query.headers,responseType=query.responseType;var requestId=requestIdCounter++;var req=(0,_extends2.default)(new XMLHttpRequest(),{requestId:requestId});this.requestStore[requestId]=req;req.open(method,url);req.withCredentials=withCredentials;req.timeout=timeout;req.responseType=responseType;req.addEventListener("load",this.handleLoad(req,responseType));req.addEventListener("loadend",this.handleLoadEnd(req));Object.entries(headers).forEach(function(_ref2){var _ref3=(0,_slicedToArray2.default)(_ref2,2),header=_ref3[0],value=_ref3[1];req.setRequestHeader(header,value);});var body;for(var _iterator2=this.requestHandlers,_isArray2=Array.isArray(_iterator2),_i2=0,_iterator2=_isArray2?_iterator2:_iterator2[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref4;if(_isArray2){if(_i2>=_iterator2.length)break;_ref4=_iterator2[_i2++];}else{_i2=_iterator2.next();if(_i2.done)break;_ref4=_i2.value;}var _handler2=_ref4;if(_handler2.canHandleNetworkingRequest(query)){var _handler2$handleNetwo=_handler2.handleNetworkingRequest(query),tempBody=_handler2$handleNetwo.body,contentType=_handler2$handleNetwo.contentType;if(tempBody){body=tempBody;req.setRequestHeader("Content-Type",contentType);break;}}}if(data.string){body=data.string;}if(data.base64){body=data.base64;}req.send(body);this.bridge.callbackFromId(callbackId)(requestId);}},{key:"$abortRequest",value:function $abortRequest(requestId){console.log("abortRequest",requestId);}},{key:"$clearCookies",value:function $clearCookies(callbackId){console.log("clearCookies");}},{key:"addRequestHandler",value:function addRequestHandler(handler){this.requestHandlers.push(handler);}},{key:"addResponseHandler",value:function addResponseHandler(handler){this.responseHandlers.push(handler);}},{key:"removeRequestHandler",value:function removeRequestHandler(handler){var index=this.requestHandlers.indexOf(handler);if(index!==-1){this.requestHandlers.splice(index,1);}}},{key:"removeResponseHandler",value:function removeResponseHandler(handler){var index=this.responseHandlers.indexOf(handler);if(index!==-1){this.responseHandlers.splice(index,1);}}}]);return RCTNetworkingNative;}(_RCTNativeEventEmitter.default);RCTNetworkingNative.moduleName="RCTNetworking";var _default=RCTNetworkingNative;exports.default=_default;
//# sourceMappingURL=RCTNetworkingNative.js.map